@model Bank.Models.Customer

@{
    ViewData["Title"] = "Details";
}

<h1>Details</h1>

<div>
    <h4>Customer</h4>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Name)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Name)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Email)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Email)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.PhoneNumber)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.PhoneNumber)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.DateJoined)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.DateJoined)
        </dd>
    </dl>
</div>

<hr />

<h4>Bank Account</h4>

@if (Model.Account == null)
{
    // SCENARIO 1: Customer has NO account.
    // Show a message and the "Create New Account" button.
    <p>This customer does not have an account yet.</p>
    <p>
        <a asp-controller="Accounts" asp-action="Create" asp-route-customerId="@Model.Id" class="btn btn-primary">Create New Account</a>
    </p>
}
else
{
    
    <table class="table">
        <thead>
        <tr>
            <th>Account Number</th>
            <th>Balance</th>
            <th>Actions</th> @* New Column *@
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>@Html.DisplayFor(model => model.Account.AccountNumber)</td>
            <td>@Html.DisplayFor(model => model.Account.Balance)</td>
            <td>
                <a asp-controller="Transactions" asp-action="CreateDeposit" asp-route-accountId="@Model.Account.Id" class="btn btn-success btn-sm">Deposit</a>
                <a asp-controller="Transactions" asp-action="CreateWithdrawal" asp-route-accountId="@Model.Account.Id" class="btn btn-danger btn-sm">Withdraw</a>
                <a asp-controller="Transactions" asp-action="CreateTransfer" asp-route-accountId="@Model.Account.Id" class="btn btn-info btn-sm">Transfer</a>
            </td>

        </tr>
        </tbody>
    </table>

}

<div class="mt-3">
    @* This link goes to the Edit page for the CUSTOMER, not the account *@
    <a asp-action="Edit" asp-route-id="@Model.Id">Edit Customer Details</a> |
    <a asp-action="Index">Back to List</a>
</div>

<hr />
<h4>Transaction History</h4>

@{
    // --- Logic for Running Balance ---
    var historyWithBalance = new List<dynamic>();
    decimal initialBalance = 0;

    if (Model.Account != null)
    {
        // THIS IS THE FIX: Safely get the data from ViewBag.
        var processedHistory = (ViewBag.TransactionHistory as IEnumerable<dynamic>) ?? Enumerable.Empty<dynamic>();
        var orderedHistory = processedHistory.OrderBy(h => h.Transaction.CreatedDate).ToList();

        // Calculate the true initial balance by reversing transactions.
        initialBalance = Model.Account.Balance;
        foreach (var item in orderedHistory)
        {
            var t = item.Transaction;
            bool isOutflow = t.Type == Bank.Models.TransactionType.Withdrawal || (t.Type == Bank.Models.TransactionType.Transfer && t.DestinationAccountId != null);
            if (isOutflow)
            {
                initialBalance += t.Amount; // Add back outflows
            }
            else
            {
                initialBalance -= t.Amount; // Subtract inflows
            }
        }

        // Calculate the running balance for each transaction.
        decimal runningBalance = initialBalance;
        foreach (var item in orderedHistory)
        {
            var transaction = item.Transaction;
            bool isOutflow = transaction.Type == Bank.Models.TransactionType.Withdrawal || (transaction.Type == Bank.Models.TransactionType.Transfer && transaction.DestinationAccountId != null);
            if (isOutflow)
            {
                runningBalance -= transaction.Amount;
            }
            else
            {
                runningBalance += transaction.Amount;
            }
            historyWithBalance.Add(new { HistoryItem = item, BalanceAfter = runningBalance });
        }
    }
    // --- End of Logic ---
}

<table class="table table-striped">
    <thead class="thead-light">
        <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Details</th>
            <th class="text-end">Debit (-)</th>  @* Outgoing Funds *@
            <th class="text-end">Credit (+)</th> @* Incoming Funds *@
            <th class="text-end">Balance</th>
        </tr>
    </thead>
    <tbody>
        @if (historyWithBalance.Any())
        {
            @foreach (var item in historyWithBalance.OrderByDescending(h => h.HistoryItem.Transaction.CreatedDate))
            {
                var transaction = item.HistoryItem.Transaction;
                var details = item.HistoryItem.Details;
                bool isOutflow = transaction.Type == Bank.Models.TransactionType.Withdrawal || (transaction.Type == Bank.Models.TransactionType.Transfer && transaction.DestinationAccountId != null);

                <tr>
                    <td>@transaction.CreatedDate.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>
                        @if (transaction.Type == Bank.Models.TransactionType.Deposit) { <span class="badge bg-success">Deposit</span> }
                        else if (transaction.Type == Bank.Models.TransactionType.Withdrawal) { <span class="badge bg-danger">Withdrawal</span> }
                        else if (isOutflow) { <span class="badge bg-warning text-dark">Transfer Out</span> }
                        else { <span class="badge bg-info">Transfer In</span> }
                    </td>
                    <td>@details</td>
                    <td class="text-end text-danger">
                        @(isOutflow ? transaction.Amount.ToString("C") : "")
                    </td>
                    <td class="text-end text-success">
                        @(!isOutflow ? transaction.Amount.ToString("C") : "")
                    </td>
                    <td class="text-end"><strong>@item.BalanceAfter.ToString("C")</strong></td>
                </tr>
            }
        }
        
        @if (Model.Account != null)
        {
            <tr class="table-light">
                <td colspan="5" class="text-end"><em>Initial Balance</em></td>
                <td class="text-end"><strong>@initialBalance.ToString("C")</strong></td>
            </tr>
        }
        else
        {
            <tr>
                <td colspan="6">
                    <p>This customer does not have a bank account yet.</p>
                </td>
            </tr>
        }
    </tbody>
</table>